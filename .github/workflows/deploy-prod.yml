name: Deploy Prod

on:
  push:
    branches: [prod]

env:
  PROD_PORT: 8000

concurrency:
  group: qcc-plus-prod-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci --no-progress
          npm run build

      - name: Deploy to prod server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 22
          script_stop: true
          timeout: 30m
          envs: PROD_PORT,APP_DIR
          script: |
            set -euo pipefail
            APP_DIR="${APP_DIR:-/opt/qcc_plus}"
            cd "$APP_DIR"
            chmod +x scripts/deploy-server.sh
            ./scripts/deploy-server.sh prod

      - name: Health check
        env:
          HOST: ${{ secrets.PROD_HOST }}
        run: |
          set -euo pipefail

          # Wait for service to be accessible externally
          echo "Waiting 10 seconds for service to stabilize..."
          sleep 10

          # Health check with retry logic
          HEALTH_URL="http://${HOST}:${PROD_PORT}/"
          MAX_ATTEMPTS=6
          RETRY_DELAY=5

          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "Health check attempt ${attempt}/${MAX_ATTEMPTS} on ${HEALTH_URL}"

            # Use explicit timeouts: 10s connect, 20s total
            # Store curl exit code and http status separately
            set +e
            status=$(curl --connect-timeout 10 --max-time 20 -s -o /dev/null -w "%{http_code}" "${HEALTH_URL}" 2>/dev/null)
            curl_exit=$?
            set -e

            # If curl failed, set status to 000
            if [ $curl_exit -ne 0 ]; then
              status="000"
              echo "HTTP status: ${status} (curl exit code: ${curl_exit})"
            else
              echo "HTTP status: ${status}"
            fi

            if [ "$status" -ge 200 ] && [ "$status" -lt 400 ] 2>/dev/null; then
              echo "Health check succeeded!"
              exit 0
            fi

            if [ "$attempt" -lt "$MAX_ATTEMPTS" ]; then
              echo "Health check failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "Health check failed after ${MAX_ATTEMPTS} attempts"
          echo "Possible causes:"
          echo "- Service not running on port ${PROD_PORT}"
          echo "- Firewall blocking port ${PROD_PORT}"
          echo "- Deploy script failed to start application"
          echo "Please check server logs: docker logs qcc_prod-proxy-1"
          exit 1
